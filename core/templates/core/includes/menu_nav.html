<!-- core/templates/core/includes/menu_nav.html -->
{% load static %}
<!-- Barra de navegación superior -->
<header class="news-header">
    <a href="{% url 'core:index' %}" class="news-logo">
        <svg viewBox="0 0 24 24">
            <path
                d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" />
            <path
                d="M12 4.5c-4.136 0-7.5 3.364-7.5 7.5s3.364 7.5 7.5 7.5 7.5-3.364 7.5-7.5-3.364-7.5-7.5-7.5zm0 14c-3.584 0-6.5-2.916-6.5-6.5s2.916-6.5 6.5-6.5 6.5 2.916 6.5 6.5-2.916 6.5-6.5 6.5z" />
            <path
                d="M12 7c-2.757 0-5 2.243-5 5s2.243 5 5 5 5-2.243 5-5-2.243-5-5-5zm0 9c-2.206 0-4-1.794-4-4s1.794-4 4-4 4 1.794 4 4-1.794 4-4 4z" />
            <circle cx="12" cy="12" r="2.5" />
        </svg>
        <span class="news-logo-text">Raíz Digital</span>
    </a>
    
    <!-- Botón de menú móvil -->
    <button id="mobileMenuToggle" class="mobile-menu-toggle" aria-label="Menú">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Navegación normal (para escritorio) -->
    <nav class="desktop-nav">
        <a href="{% url 'core:marketplace' %}"
            class="nav-link {% if request.resolver_match.url_name == 'marketplace' %}active{% endif %}">Inicio</a>
        <a href="{% url 'core:noticias' %}"
            class="nav-link {% if request.resolver_match.url_name == 'noticias' or request.resolver_match.url_name == 'noticia_detalle' or request.resolver_match.url_name == 'crear_noticia' or request.resolver_match.url_name == 'editar_noticia' %}active{% endif %}">Noticias</a>
        <a href="#" class="nav-link {% if request.resolver_match.url_name == 'eventos' %}active{% endif %}">Eventos</a>
        <a href="#"
            class="nav-link {% if request.resolver_match.url_name == 'productos' %}active{% endif %}">Productos</a>
        
        <!-- Enlace de logout para escritorio -->
        {% if request.session.user_id %}
        <a href="#" id="desktopLogoutBtn" class="nav-link logout-link" title="Cerrar sesión">
            <svg viewBox="0 0 24 24" width="18" height="18" style="margin-right: 5px; vertical-align: middle;">
                <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            Salir
        </a>
        {% endif %}
    </nav>
</header>

<!-- Menú móvil único -->
<div id="mobileMenu" class="mobile-nav">
    <div class="mobile-menu-backdrop"></div>
    <div class="mobile-menu-content">
        <a href="{% url 'core:marketplace' %}"
            class="mobile-nav-link {% if request.resolver_match.url_name == 'marketplace' %}active{% endif %}">
            <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
            <span class="mobile-nav-text">Inicio</span>
        </a>
        <a href="{% url 'core:noticias' %}"
            class="mobile-nav-link {% if request.resolver_match.url_name == 'noticias' or request.resolver_match.url_name == 'noticia_detalle' or request.resolver_match.url_name == 'crear_noticia' or request.resolver_match.url_name == 'editar_noticia' %}active{% endif %}">
            <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                <path
                    d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-1 14H5c-.55 0-1-.45-1-1V7c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v10c0 .55-.45 1-1 1z" />
                <path d="M8.5 15h2v2h-2zm0-8h2v6h-2zm3.5 0h2v2h-2zm0 3h2v5h-2zm3.5 0h2v2h-2zm0 3h2v2h-2z" />
            </svg>
            <span class="mobile-nav-text">Noticias</span>
        </a>
        <a href="#" class="mobile-nav-link {% if request.resolver_match.url_name == 'eventos' %}active{% endif %}">
            <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                <path
                    d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V9h14v10zM5 7V5h14v2H5z" />
                <path d="M7 11h10v2H7zm0 4h7v2H7z" />
            </svg>
            <span class="mobile-nav-text">Eventos</span>
        </a>
        <a href="#" class="mobile-nav-link {% if request.resolver_match.url_name == 'productos' %}active{% endif %}">
            <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                <path
                    d="M18 6h-2c0-2.21-1.79-4-4-4S8 3.79 8 6H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-6-2c1.1 0 2 .9 2 2h-4c0-1.1.9-2 2-2zm6 16H6V8h2v2c0 .55.45 1 1 1s1-.45 1-1V8h4v2c0 .55.45 1 1 1s1-.45 1-1V8h2v12z" />
            </svg>
            <span class="mobile-nav-text">Productos</span>
        </a>
        
        <!-- Enlace de logout para móvil -->
        {% if request.session.user_id %}
        <a href="#" id="mobileLogoutBtn" class="mobile-nav-link logout">
            <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                <path
                    d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
            </svg>
            <span class="mobile-nav-text">Cerrar sesión</span>
        </a>
        {% endif %}
    </div>
</div>

<!-- Script JavaScript para el menú móvil y logout -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Menú móvil
    const menuToggle = document.getElementById('mobileMenuToggle');
    const mobileMenu = document.getElementById('mobileMenu');

    if (menuToggle && mobileMenu) {
        // Escuchar eventos de clic
        menuToggle.addEventListener('click', function () {
            // Toggle de clases para activar/desactivar
            menuToggle.classList.toggle('active');
            mobileMenu.classList.toggle('active');

            // Forzar visibilidad si está activo
            if (mobileMenu.classList.contains('active')) {
                mobileMenu.style.opacity = '1';
                mobileMenu.style.visibility = 'visible';
                mobileMenu.style.pointerEvents = 'auto';

                // Forzar visibilidad del contenido
                const content = mobileMenu.querySelector('.mobile-menu-content');
                if (content) {
                    content.style.opacity = '1';
                    content.style.transform = 'translate(-50%, -50%) scale(1)';
                }

                // Forzar visibilidad del backdrop
                const backdrop = mobileMenu.querySelector('.mobile-menu-backdrop');
                if (backdrop) {
                    backdrop.style.opacity = '1';
                }
            } else {
                // Restaurar estado normal
                mobileMenu.style.opacity = '0';
                mobileMenu.style.visibility = 'hidden';
                mobileMenu.style.pointerEvents = 'none';
            }
        });

        // Cerrar menú al hacer clic en el backdrop o enlaces (excepto logout)
        const backdrop = mobileMenu.querySelector('.mobile-menu-backdrop');
        if (backdrop) {
            backdrop.addEventListener('click', closeMenu);
        }

        const mobileLinks = mobileMenu.querySelectorAll('.mobile-nav-link:not(.logout)');
        mobileLinks.forEach(link => {
            link.addEventListener('click', closeMenu);
        });

        function closeMenu() {
            menuToggle.classList.remove('active');
            mobileMenu.classList.remove('active');
            mobileMenu.style.opacity = '0';
            mobileMenu.style.visibility = 'hidden';
            mobileMenu.style.pointerEvents = 'none';
        }
    }

    // Funcionalidad de logout
    function handleLogout(event) {
        event.preventDefault();
        
        // Mostrar confirmación
        if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
            // Crear formulario para logout
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "core:logout" %}';
            
            // Agregar token CSRF
            const csrfToken = getCookie('csrftoken');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
            }
            
            // Enviar formulario
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Función para obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Agregar evento de logout para escritorio y móvil
    const desktopLogoutBtn = document.getElementById('desktopLogoutBtn');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    
    if (desktopLogoutBtn) {
        desktopLogoutBtn.addEventListener('click', handleLogout);
    }
    
    if (mobileLogoutBtn) {
        mobileLogoutBtn.addEventListener('click', handleLogout);
    }
});
</script>