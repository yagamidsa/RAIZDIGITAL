{% extends 'core/base.html' %}
{% load static %}

{% block title %}Registro - Ra√≠z Digital{% endblock %}

{% block extra_css %}
<!-- üîß CARGAR VARIABLES CSS PRIMERO SIEMPRE -->
<link rel="stylesheet" href="{% static 'core/css/variables.css' %}?v=1">

<!-- ‚ú® LIBRER√çAS PROFESIONALES PREMIUM ‚ú® -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
<link rel="stylesheet" href="{% static 'core/css/register.css' %}?v=2">
{% endblock %}

{% block content %}
<!-- üåà ELEMENTOS FLOTANTES DE FONDO -->
<div class="floating-elements">
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
</div>

<div class="page-container">
    <div class="register-container">
        <!-- Bot√≥n volver -->
        <a href="{% url 'core:login' %}" class="back-button">
            <svg class="back-icon" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
            </svg>
            <span>Volver al Login</span>
        </a>

        <div class="register-border"></div>
        <div class="register-content">
            <!-- Header con √≠cono de app verde ne√≥n -->
            <div class="register-header">
                <div class="app-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/>
                        <path d="M12 4.5c-4.136 0-7.5 3.364-7.5 7.5s3.364 7.5 7.5 7.5 7.5-3.364 7.5-7.5-3.364-7.5-7.5-7.5zm0 14c-3.584 0-6.5-2.916-6.5-6.5s2.916-6.5 6.5-6.5 6.5 2.916 6.5 6.5-2.916 6.5-6.5 6.5z"/>
                        <circle cx="12" cy="12" r="2.5"/>
                    </svg>
                </div>
                <h2 class="register-title">Crear Cuenta</h2>
                <p class="register-subtitle">√önete a la comunidad digital de tradiciones</p>
            </div>

            <!-- MENSAJES DE ERROR Y √âXITO -->
            {% if errors %}
            <div class="error-messages">
                <ul>
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if messages %}
                {% for message in messages %}
                    {% if message.tags == 'success' %}
                        <div class="success-message">
                            {{ message }}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            <form class="register-form" method="post" action="{% url 'core:register' %}" novalidate>
                {% csrf_token %}
                
                <!-- Nombre -->
                <div class="form-group">
                    <label class="form-label required">Nombre</label>
                    <div class="input-wrapper">
                        <input type="text" class="form-input" name="nombre" 
                               value="{{ form_data.nombre|default:'' }}" 
                               placeholder="Tu nombre" required>
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Apellido -->
                <div class="form-group">
                    <label class="form-label required">Apellido</label>
                    <div class="input-wrapper">
                        <input type="text" class="form-input" name="apellido" 
                               value="{{ form_data.apellido|default:'' }}" 
                               placeholder="Tu apellido" required>
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Usuario -->
                <div class="form-group">
                    <label class="form-label required">Usuario</label>
                    <div class="input-wrapper">
                        <input type="text" class="form-input" name="username" 
                               value="{{ form_data.username|default:'' }}" 
                               placeholder="Nombre de usuario √∫nico" required>
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Email -->
                <div class="form-group">
                    <label class="form-label required">Email</label>
                    <div class="input-wrapper">
                        <input type="email" class="form-input" name="email" 
                               value="{{ form_data.email|default:'' }}" 
                               placeholder="tu@email.com" required>
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Contrase√±a -->
                <div class="form-group">
                    <label class="form-label required">Contrase√±a</label>
                    <div class="input-wrapper">
                        <input type="password" class="form-input" name="password" 
                               placeholder="M√≠nimo 8 caracteres" required>
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Confirmar Contrase√±a -->
                <div class="form-group">
                    <label class="form-label required">Confirmar Contrase√±a</label>
                    <div class="input-wrapper">
                        <input type="password" class="form-input" name="password_confirm" 
                               placeholder="Repite tu contrase√±a" required>
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Fecha de Nacimiento -->
                <div class="form-group">
                    <label class="form-label">Fecha de Nacimiento</label>
                    <div class="input-wrapper">
                        <input type="date" class="form-input" name="fecha_nacimiento"
                               value="{{ form_data.fecha_nacimiento|default:'' }}">
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Tel√©fono -->
                <div class="form-group">
                    <label class="form-label">Tel√©fono</label>
                    <div class="input-wrapper">
                        <input type="tel" class="form-input" name="telefono" 
                               value="{{ form_data.telefono|default:'' }}" 
                               placeholder="+57 300 123 4567">
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Comunidad -->
                <div class="form-group">
                    <label class="form-label required">Comunidad</label>
                    <div class="input-wrapper">
                        <select class="form-select" name="id_comunidad" required>
                            <option value="">Selecciona tu comunidad</option>
                            {% for comunidad in comunidades %}
                            <option value="{{ comunidad.id }}" 
                                    {% if form_data.id_comunidad|default:'' == comunidad.id|stringformat:"s" %}selected{% endif %}>
                                {{ comunidad.display_name }}
                            </option>
                            {% endfor %}
                            {% if not comunidades %}
                            <option value="" disabled>No hay comunidades disponibles</option>
                            {% endif %}
                        </select>
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Direcci√≥n -->
                <div class="form-group">
                    <label class="form-label">Direcci√≥n</label>
                    <div class="input-wrapper">
                        <input type="text" class="form-input" name="direccion" 
                               value="{{ form_data.direccion|default:'' }}" 
                               placeholder="Tu direcci√≥n (opcional)">
                        <div class="input-effect"></div>
                    </div>
                </div>

                <!-- Biograf√≠a -->
                <div class="form-group">
                    <label class="form-label">Cu√©ntanos sobre ti</label>
                    <div class="input-wrapper">
                        <textarea class="form-input" name="biografia" rows="3" 
                                  placeholder="Breve descripci√≥n sobre ti y tus intereses en las tradiciones (opcional)">{{ form_data.biografia|default:'' }}</textarea>
                        <div class="input-effect"></div>
                    </div>
                </div>

                <button type="submit" class="btn-submit">
                    <span>Crear Mi Cuenta</span>
                </button>
            </form>

            <div class="verification-info">
                <strong>üìß Verificaci√≥n de Email:</strong><br>
                Despu√©s del registro, enviaremos un email de verificaci√≥n a tu correo. 
                Debes verificar tu cuenta para poder acceder completamente a la plataforma.
            </div>

            <div class="login-link">
                ¬øYa tienes una cuenta? <a href="{% url 'core:login' %}">Inicia sesi√≥n aqu√≠</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/digital-effects.js' %}"></script>

<!-- üîß SCRIPT CR√çTICO PARA DEBUG Y FUNCIONALIDAD M√ìVIL -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Registro - Versi√≥n CORREGIDA para m√≥vil iniciada');
    
    // üîß DEBUG: Verificar carga de archivos CSS
    const link = document.querySelector('link[href*="variables.css"]');
    if (link) {
        console.log('‚úÖ variables.css detectado:', link.href);
        
        // Verificar si se carg√≥ correctamente
        link.onload = function() {
            console.log('‚úÖ variables.css cargado exitosamente');
        };
        
        link.onerror = function() {
            console.log('‚ùå Error cargando variables.css');
            console.log('üîß Usando estilos inline de fallback');
        };
    } else {
        console.log('‚ùå variables.css NO encontrado');
    }
    
    // üîß DEBUG: Verificar estilos aplicados
    const testElement = document.querySelector('.register-container');
    if (testElement) {
        const styles = window.getComputedStyle(testElement);
        console.log('üé® Background del container:', styles.background);
        console.log('üé® Border radius:', styles.borderRadius);
        
        if (styles.background.includes('rgba') || styles.borderRadius !== '0px') {
            console.log('‚úÖ Estilos CSS aplicados correctamente');
        } else {
            console.log('‚ö†Ô∏è Estilos CSS no aplicados, usando fallback inline');
        }
    }
    
    // üîß OPTIMIZACIONES PARA M√ìVIL
    if (window.innerWidth <= 768) {
        console.log('üì± Modo m√≥vil detectado - aplicando optimizaciones');
        
        // Prevenir zoom en inputs
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.style.fontSize = '16px'; // Prevenir zoom en iOS
        });
        
        // Optimizar scroll
        document.body.style.webkitOverflowScrolling = 'touch';
        document.body.style.overscrollBehavior = 'none';
        
        // Prevenir pull-to-refresh
        let startY = 0;
        document.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
            const currentY = e.touches[0].clientY;
            const scrollTop = window.scrollY;
            
            if (scrollTop <= 0 && currentY > startY) {
                e.preventDefault();
            }
        }, { passive: false });
    }
    
    // üîß SISTEMA DE VALIDACI√ìN MEJORADO
    const form = document.querySelector('.register-form');
    const inputs = form.querySelectorAll('.form-input, .form-select');
    const submitBtn = form.querySelector('.btn-submit');

    // Validaci√≥n en tiempo real
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            validateField(this);
        });
        
        input.addEventListener('blur', function() {
            validateField(this);
        });
    });

    function validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        let isValid = true;

        field.classList.remove('valid', 'invalid');

        if (value.length === 0) {
            return true; // Campo vac√≠o - no mostrar validaci√≥n
        }

        switch(fieldName) {
            case 'nombre':
            case 'apellido':
                isValid = value.length >= 2;
                break;
            case 'username':
                isValid = value.length >= 3 && /^[a-zA-Z0-9_]+$/.test(value);
                break;
            case 'email':
                isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
                break;
            case 'password':
                isValid = value.length >= 8;
                break;
            case 'password_confirm':
                const password = document.querySelector('input[name="password"]').value;
                isValid = value === password;
                break;
        }

        if (isValid) {
            field.classList.add('valid');
        } else {
            field.classList.add('invalid');
        }

        return isValid;
    }

    // üîß MANEJO DEL ENV√çO DEL FORMULARIO
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üìù Enviando formulario...');
            
            // Validar campos requeridos
            const requiredFields = form.querySelectorAll('input[required], select[required]');
            let allValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('invalid');
                    allValid = false;
                }
            });
            
            if (!allValid) {
                e.preventDefault();
                showNotification('Por favor, completa todos los campos obligatorios', 'error');
                return;
            }
            
            // Validar contrase√±as
            const password = document.querySelector('input[name="password"]').value;
            const confirmPassword = document.querySelector('input[name="password_confirm"]').value;
            
            if (password !== confirmPassword) {
                e.preventDefault();
                showNotification('Las contrase√±as no coinciden', 'error');
                return;
            }
            
            if (password.length < 8) {
                e.preventDefault();
                showNotification('La contrase√±a debe tener al menos 8 caracteres', 'error');
                return;
            }
            
            // Agregar loading al bot√≥n
            if (submitBtn) {
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
            }
            
            console.log('‚úÖ Formulario v√°lido, enviando...');
        });
    }

    // üîß SISTEMA DE NOTIFICACIONES
    function showNotification(message, type = 'info') {
        // Remover notificaciones existentes
        const existing = document.querySelectorAll('.notification');
        existing.forEach(n => n.remove());
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="notification-icon">${getNotificationIcon(type)}</div>
                <span>${message}</span>
            </div>
        `;
        
        notification.style.cssText = `
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            font-weight: 600;
            z-index: 9999;
            max-width: 400px;
            backdrop-filter: blur(20px);
            border: 1px solid;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.4s ease;
        `;
        
        if (type === 'error') {
            notification.style.background = 'rgba(240, 65, 65, 0.9)';
            notification.style.color = 'white';
            notification.style.borderColor = '#f04141';
        } else if (type === 'success') {
            notification.style.background = 'rgba(0, 224, 133, 0.9)';
            notification.style.color = 'white';
            notification.style.borderColor = '#00ff9d';
        }
        
        // Ajustar para m√≥vil
        if (window.innerWidth <= 768) {
            notification.style.top = '1rem';
            notification.style.right = '1rem';
            notification.style.left = '1rem';
            notification.style.maxWidth = 'none';
        }
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 400);
        }, 4000);
    }

    function getNotificationIcon(type) {
        switch(type) {
            case 'error': return '‚ö†Ô∏è';
            case 'success': return '‚úÖ';
            default: return 'üíö';
        }
    }

    // üîß CARGAR LIBRER√çAS EXTERNAS DE FORMA SEGURA
    function loadExternalLibraries() {
        // AOS - Animaciones
        if (typeof AOS !== 'undefined' && window.innerWidth > 768) {
            try {
                AOS.init({
                    duration: 600,
                    easing: 'ease-out-cubic',
                    once: true,
                    offset: 30,
                    disable: window.innerWidth <= 768
                });
                console.log('‚úÖ AOS inicializado');
            } catch (error) {
                console.log('‚ö†Ô∏è Error inicializando AOS:', error);
            }
        }

        // GSAP - Animaciones avanzadas
        if (typeof gsap !== 'undefined' && window.innerWidth > 768) {
            try {
                gsap.config({
                    force3D: true,
                    nullTargetWarn: false
                });

                // Animaci√≥n sutil del contenedor
                gsap.fromTo('.register-container', 
                    { scale: 0.98, opacity: 0, y: 20 },
                    { scale: 1, opacity: 1, y: 0, duration: 0.6, ease: "power2.out" }
                );

                console.log('‚úÖ GSAP inicializado');
            } catch (error) {
                console.log('‚ö†Ô∏è Error inicializando GSAP:', error);
            }
        }
    }

    // Cargar librer√≠as despu√©s de un breve delay
    setTimeout(loadExternalLibraries, 500);

    // üîß FIELD FOCUS MEJORADO PARA M√ìVIL
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            // Scroll suave al campo en m√≥vil
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    this.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'nearest'
                    });
                }, 300); // Delay para que el teclado aparezca
            }
        });
    });

    // üîß MANEJO DE ORIENTACI√ìN EN M√ìVIL
    window.addEventListener('orientationchange', function() {
        setTimeout(() => {
            // Re-optimizar despu√©s del cambio de orientaci√≥n
            if (window.innerWidth <= 768) {
                document.body.style.height = 'auto';
                window.scrollTo(0, 0);
            }
        }, 200);
    });

    console.log('‚ú® Registro m√≥vil - Inicializaci√≥n completa');
});

// üîß SCRIPT PARA DETECTAR PROBLEMAS DE CARGA CSS
window.addEventListener('load', function() {
    const cssLoaded = Array.from(document.styleSheets).some(sheet => {
        try {
            return sheet.href && sheet.href.includes('variables.css');
        } catch (e) {
            return false;
        }
    });
    
    if (cssLoaded) {
        console.log('‚úÖ CSS externo cargado correctamente');
    } else {
        console.log('‚ö†Ô∏è CSS externo no detectado - usando estilos inline');
    }
    
    // Test final de estilos
    const container = document.querySelector('.register-container');
    if (container) {
        const bgColor = window.getComputedStyle(container).backgroundColor;
        if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
            console.log('‚úÖ Estilos aplicados correctamente');
        } else {
            console.log('‚ùå Estilos no aplicados - problema con archivos CSS');
        }
    }
});
</script>

{% if success %}
{% include 'core/includes/success_modal.html' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userData = {
        username: '{{ form_data.username|default:"" }}',
        email: '{{ form_data.email|default:"" }}'
    };
    
    // Mostrar el modal autom√°ticamente
    if (window.showEpicSuccessModal) {
        window.showEpicSuccessModal({
            title: "¬°REGISTRO EXITOSO!",
            subtitle: "Bienvenido a Ra√≠z Digital",
            message: "Tu cuenta ha sido creada exitosamente para " + userData.username + ".",
            verificationText: "Hemos enviado un enlace de verificaci√≥n a " + userData.email + ". Por favor revisa tu bandeja de entrada."
        });
    }
});
</script>
{% endif %}
{% endblock %}