<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>{% block title %}Ra√≠z Digital{% endblock %}</title>
    {% load static %}

    <!-- Estilos base -->
    <link rel="stylesheet" href="{% static 'core/css/variables.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/menu_nav.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/mobile-performance.css' %}">

    {% block extra_css %}{% endblock %}
</head>

<body class="{% if request.resolver_match.url_name == 'index' %}no-menu{% else %}has-menu{% endif %}">
    <!-- Incluir el men√∫ de navegaci√≥n solo para p√°ginas que no sean las seleccionadas-->
    {% if request.resolver_match.url_name not in 'index,login,password_recovery,register,marketplace' %}
    {% include 'core/includes/menu_nav.html' %}
    {% endif %}

    <canvas id="backgroundCanvas"></canvas>
    <div class="content-wrapper">
        {% block content %}{% endblock %}
    </div>

    <!-- Scripts base OPTIMIZADOS CONSERVADORES PARA M√ìVIL -->
    <script>
        // ==================================================
        // üöÄ OPTIMIZACIONES M√ìVIL CONSERVADORAS - CORREGIDO
        // ==================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± Iniciando optimizaciones m√≥vil conservadoras...');
            
            // 1. DETECTAR DISPOSITIVO
            const isMobile = window.innerWidth <= 768;
            const isLowEnd = isMobile && (
                navigator.hardwareConcurrency <= 2 || 
                navigator.deviceMemory <= 2
            );
            
            console.log(`üì± M√≥vil: ${isMobile}, Dispositivo b√°sico: ${isLowEnd}`);
            
            if (isMobile) {
                applyMobileOptimizations();
                
                if (isLowEnd) {
                    applyLowEndOptimizations();
                } else {
                    setupLightweightCanvas();
                }
                
                // Indicador temporal
                showMobileOptimizationIndicator();
            } else {
                // DESKTOP: Configuraci√≥n normal
                setupDesktopCanvas();
            }
        });

        // ==================================================
        // FUNCIONES DE OPTIMIZACI√ìN CONSERVADORAS
        // ==================================================

        function applyMobileOptimizations() {
            console.log('üì± Aplicando optimizaciones m√≥vil conservadoras...');
            
            // SOLO desactivar elementos realmente pesados
            const heavyElements = document.querySelectorAll(
                '.cyber-grid, .organic-shapes, .particles-container, .floating-elements'
            );
            
            heavyElements.forEach(element => {
                element.style.display = 'none';
            });
            
            // Optimizar scroll SIN forzar dimensiones
            if (document.body) {
                document.body.style.webkitOverflowScrolling = 'touch';
                document.body.style.overscrollBehavior = 'none';
            }
            
            // Prevenir zoom doble-tap SOLO cuando sea necesario
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    const target = event.target;
                    if (!target.closest('button, a, input, textarea, select')) {
                        event.preventDefault();
                    }
                }
                lastTouchEnd = now;
            }, false);
            
            console.log('‚úÖ Optimizaciones m√≥vil aplicadas');
        }

        function applyLowEndOptimizations() {
            console.log('üîß Optimizaciones para dispositivos b√°sicos...');
            
            // Canvas completamente oculto
            const canvas = document.getElementById('backgroundCanvas');
            if (canvas) {
                canvas.style.display = 'none';
            }
            
            // Background s√≥lido
            document.body.style.background = '#041222';
            
            console.log('‚úÖ Optimizaciones dispositivos b√°sicos aplicadas');
        }

        function setupLightweightCanvas() {
            console.log('üé® Canvas ligero para m√≥vil...');
            
            const canvas = document.getElementById('backgroundCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Funci√≥n para redimensionar canvas
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            resizeCanvas();
            
            // Solo 3 part√≠culas ligeras
            const particles = [];
            for (let i = 0; i < 3; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.3,
                    vy: (Math.random() - 0.5) * 0.3,
                    opacity: Math.random() * 0.2 + 0.05
                });
            }
            
            let lastTime = 0;
            const targetFPS = 20;
            const frameTime = 1000 / targetFPS;
            
            function animate(currentTime) {
                if (currentTime - lastTime < frameTime) {
                    requestAnimationFrame(animate);
                    return;
                }
                
                lastTime = currentTime;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach(particle => {
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, 0.5, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(0, 255, 157, ${particle.opacity})`;
                    ctx.fill();
                    
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    if (particle.x < 0 || particle.x > canvas.width) particle.vx *= -1;
                    if (particle.y < 0 || particle.y > canvas.height) particle.vy *= -1;
                });
                
                requestAnimationFrame(animate);
            }
            
            animate(0);
            
            // Redimensionar en resize
            window.addEventListener('resize', resizeCanvas);
            
            console.log('‚úÖ Canvas ligero configurado');
        }

        function setupDesktopCanvas() {
            // Para desktop usar canvas normal si existe
            const canvas = document.getElementById('backgroundCanvas');
            if (!canvas) return;
            
            if (typeof OptimizedCanvasEffect !== 'undefined') {
                new OptimizedCanvasEffect(canvas);
            }
        }

        function showMobileOptimizationIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'debug-mobile-performance';
            indicator.textContent = 'M√ìVIL OPTIMIZADO';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 3000);
        }

        // Variables globales simples
        window.userSessionData = {
            isLoggedIn: !!(
                document.querySelector('.user-info') || 
                document.querySelector('.mobile-nav-link.logout') ||
                '{{ request.session.user_id }}'
            ),
            userId: '{{ request.session.user_id|default:"" }}',
            username: '{{ request.session.username|default:"" }}',
            startTime: Date.now()
        };

        // Resize throttling simple
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                // Solo ajustar canvas si existe y est√° visible
                const canvas = document.getElementById('backgroundCanvas');
                if (canvas && canvas.style.display !== 'none') {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }
            }, 250);
        });

        console.log('üîê Estado de sesi√≥n:', window.userSessionData);
        console.log('‚úÖ Optimizaciones m√≥vil conservadoras aplicadas');
    </script>

    <!-- Sistema de auto-logout simplificado -->
    {% if request.session.user_id %}
    <script src="{% static 'core/js/auto-logout.js' %}?v=1"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if ('{{ request.session.user_id }}' && typeof AutoLogoutSystem !== 'undefined') {
                setTimeout(function() {
                    window.autoLogoutSystem = new AutoLogoutSystem({
                        timeout: 3 * 60 * 1000,
                        warningTime: 30 * 1000,
                        logoutUrl: '{% url "core:login" %}',
                        checkInterval: 2000
                    });
                }, 1000);
            }
        });
    </script>
    {% endif %}

    {% block extra_js %}{% endblock %}
</body>

</html>