<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>{% block title %}Ra√≠z Digital{% endblock %}</title>
    {% load static %}

    <!-- Estilos base -->
    <link rel="stylesheet" href="{% static 'core/css/variables.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/menu_nav.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/mobile-performance.css' %}">

    {% block extra_css %}{% endblock %}
</head>

<body class="{% if request.resolver_match.url_name == 'index' %}no-menu{% else %}has-menu{% endif %}">
    <!-- Incluir el men√∫ de navegaci√≥n solo para p√°ginas que no sean las seleccionadas-->
    {% if request.resolver_match.url_name not in 'index,login,password_recovery,register,marketplace' %}
    {% include 'core/includes/menu_nav.html' %}
    {% endif %}

    <canvas id="backgroundCanvas"></canvas>
    <div class="content-wrapper">
        {% block content %}{% endblock %}
    </div>

    <!-- Scripts base S√öPER OPTIMIZADOS PARA M√ìVIL -->
    <script>
        // ==================================================
        // üöÄ OPTIMIZACIONES CR√çTICAS PARA M√ìVIL
        // ==================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± Iniciando optimizaciones s√∫per m√≥vil...');
            
            // 1. DETECTAR DISPOSITIVO
            const isMobile = window.innerWidth <= 768;
            const isLowEnd = isMobile && (
                navigator.hardwareConcurrency <= 2 || 
                navigator.deviceMemory <= 2 ||
                /Android.*4\.|iPhone.*OS [5-9]_/.test(navigator.userAgent)
            );
            
            console.log(`üì± M√≥vil: ${isMobile}, Dispositivo b√°sico: ${isLowEnd}`);
            
            if (isMobile) {
                // APLICAR TODAS LAS OPTIMIZACIONES M√ìVIL
                disableHeavyElements();
                optimizeMobileScroll();
                
                if (isLowEnd) {
                    applyLowEndOptimizations();
                } else {
                    setupLightweightCanvas();
                }
                
                // Indicador visual temporal
                showMobileOptimizationIndicator();
            } else {
                // DESKTOP: Configuraci√≥n normal
                setupDesktopCanvas();
            }
        });

        // ==================================================
        // FUNCIONES DE OPTIMIZACI√ìN M√ìVIL
        // ==================================================

        function disableHeavyElements() {
            console.log('üö´ Desactivando elementos pesados...');
            
            // Lista de elementos pesados
            const heavySelectors = [
                '.cyber-grid',
                '.organic-shapes', 
                '.particles-container',
                '.floating-elements',
                '.energy-wave-epic',
                '.ambient-light-epic',
                '.organic-shape',
                '.floating-circle'
            ];
            
            heavySelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    element.style.display = 'none';
                    element.style.opacity = '0';
                    element.style.visibility = 'hidden';
                });
            });
            
            // Desactivar animaciones CSS
            const style = document.createElement('style');
            style.textContent = `
                @media (max-width: 768px) {
                    *, *::before, *::after {
                        animation: none !important;
                        transition-duration: 0.1s !important;
                    }
                }
            `;
            document.head.appendChild(style);
            
            console.log('‚úÖ Elementos pesados desactivados');
        }

        function optimizeMobileScroll() {
            console.log('üìú Optimizando scroll m√≥vil...');
            
            // Configuraci√≥n √≥ptima
            document.documentElement.style.scrollBehavior = 'auto';
            document.body.style.webkitOverflowScrolling = 'touch';
            document.body.style.overscrollBehavior = 'none';
            
            // Prevenir rebote solo en extremos
            let startY = 0;
            
            document.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchmove', function(e) {
                const currentY = e.touches[0].clientY;
                const scrollTop = window.scrollY;
                const maxScroll = document.body.scrollHeight - window.innerHeight;
                
                if ((scrollTop <= 0 && currentY > startY) || 
                    (scrollTop >= maxScroll && currentY < startY)) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            console.log('‚úÖ Scroll m√≥vil optimizado');
        }

        function applyLowEndOptimizations() {
            console.log('üîß Aplicando optimizaciones para dispositivos b√°sicos...');
            
            // Desactivar canvas completamente
            const canvas = document.getElementById('backgroundCanvas');
            if (canvas) {
                canvas.style.display = 'none';
            }
            
            // Background s√≥lido
            document.body.style.background = '#041222';
            
            // Eliminar todos los efectos
            const style = document.createElement('style');
            style.textContent = `
                * {
                    filter: none !important;
                    backdrop-filter: none !important;
                    box-shadow: none !important;
                    border-radius: 4px !important;
                }
            `;
            document.head.appendChild(style);
            
            console.log('‚úÖ Optimizaciones dispositivos b√°sicos aplicadas');
        }

        function setupLightweightCanvas() {
            console.log('üé® Canvas ligero para m√≥vil...');
            
            const canvas = document.getElementById('backgroundCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Solo 3 part√≠culas
            const particles = [];
            for (let i = 0; i < 3; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.3,
                    vy: (Math.random() - 0.5) * 0.3,
                    opacity: Math.random() * 0.2 + 0.05
                });
            }
            
            let lastTime = 0;
            const targetFPS = 20; // 20fps m√°ximo
            const frameTime = 1000 / targetFPS;
            
            function animate(currentTime) {
                if (currentTime - lastTime < frameTime) {
                    requestAnimationFrame(animate);
                    return;
                }
                
                lastTime = currentTime;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach(particle => {
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, 0.5, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(0, 255, 157, ${particle.opacity})`;
                    ctx.fill();
                    
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    if (particle.x < 0 || particle.x > canvas.width) particle.vx *= -1;
                    if (particle.y < 0 || particle.y > canvas.height) particle.vy *= -1;
                });
                
                requestAnimationFrame(animate);
            }
            
            animate(0);
            console.log('‚úÖ Canvas ligero configurado');
        }

        function setupDesktopCanvas() {
            // Para desktop usar el canvas normal pero optimizado
            const canvas = document.getElementById('backgroundCanvas');
            if (!canvas) return;
            
            // Usar OptimizedCanvasEffect si existe
            if (typeof OptimizedCanvasEffect !== 'undefined') {
                new OptimizedCanvasEffect(canvas);
            }
        }

        function showMobileOptimizationIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'debug-mobile-performance';
            indicator.textContent = 'M√ìVIL OPTIMIZADO';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 3000);
        }

        // Variables globales optimizadas
        window.userSessionData = {
            isLoggedIn: !!(
                document.querySelector('.user-info') || 
                document.querySelector('.mobile-nav-link.logout') ||
                document.body.classList.contains('has-menu') ||
                '{{ request.session.user_id }}'
            ),
            userId: '{{ request.session.user_id|default:"" }}',
            username: '{{ request.session.username|default:"" }}',
            startTime: Date.now()
        };

        // Prevenir zoom accidental optimizado
        if (window.innerWidth <= 768) {
            let lastTouchEnd = 0;
            
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    const target = event.target;
                    if (!target.closest('button, a, input, textarea, select, [onclick], [role="button"]')) {
                        event.preventDefault();
                    }
                }
                lastTouchEnd = now;
            }, false);
        }

        // Resize throttling s√∫per optimizado
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (window.innerWidth <= 768) {
                    document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
                    
                    // Re-optimizar si es necesario
                    const canvas = document.getElementById('backgroundCanvas');
                    if (canvas && canvas.style.display !== 'none') {
                        canvas.width = window.innerWidth;
                        canvas.height = window.innerHeight;
                    }
                }
            }, 250);
        });

        console.log('üîê Estado de sesi√≥n:', window.userSessionData);
        console.log('‚úÖ Optimizaciones m√≥vil aplicadas');
    </script>

    <!-- Sistema de auto-logout simplificado -->
    {% if request.session.user_id %}
    <script src="{% static 'core/js/auto-logout.js' %}?v=1"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if ('{{ request.session.user_id }}' && typeof AutoLogoutSystem !== 'undefined') {
                setTimeout(function() {
                    window.autoLogoutSystem = new AutoLogoutSystem({
                        timeout: 3 * 60 * 1000,
                        warningTime: 30 * 1000,
                        logoutUrl: '{% url "core:login" %}',
                        checkInterval: 2000 // Menos frecuente para ahorrar recursos
                    });
                }, 1000); // Cargar despu√©s para no afectar rendimiento inicial
            }
        });
    </script>
    {% endif %}

    {% block extra_js %}{% endblock %}
</body>

</html>