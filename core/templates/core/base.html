<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Raíz Digital{% endblock %}</title>
    {% load static %}

    <!-- Estilos base -->
    <link rel="stylesheet" href="{% static 'core/css/variables.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/menu_nav.css' %}">
    <!-- TEMPORAL: Comentar performance.css hasta arreglarlo -->
    <!-- <link rel="stylesheet" href="{% static 'core/css/performance.css' %}"> -->

    <style>
        :root {
            --neon-green: #00ff9d;
            --cyber-blue: #00f6ff;
            --dark-blue: #041222;
            --dark-green: #051f17;
        }

        /* ===============================================
           RESET TOTAL PARA EVITAR CONFLICTOS
           =============================================== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* CRÍTICO: NO optimizaciones globales que causen problemas */
        }

        /* ===============================================
           SCROLL ÚNICO Y CONTROLADO
           =============================================== */

        html {
            /* SCROLL PRINCIPAL: Solo vertical, nunca horizontal */
            overflow-x: hidden !important;
            overflow-y: auto !important;
            width: 100vw !important;
            max-width: 100vw !important;
            height: 100%;
            scroll-behavior: smooth;
        }

        body {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #061826 50%, var(--dark-green) 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            position: relative;
            color: white;
            
            /* SCROLL CONTROL: Solo body maneja scroll vertical */
            overflow-x: hidden !important;
            overflow-y: auto !important;
            width: 100vw !important;
            max-width: 100vw !important;
            
            /* EVITAR PROBLEMAS: Sin optimizaciones en body */
        }

        /* ===============================================
           PREVENIR OVERFLOW EN TODOS LOS CONTENEDORES
           =============================================== */

        .content-wrapper,
        .news-container,
        .welcome-container,
        .main-content,
        .news-content,
        .page-container {
            overflow: visible !important;
            width: 100% !important;
            max-width: 100% !important;
            /* NO aplicar optimizaciones aquí */
        }

        /* ===============================================
           CANVAS SIN PROBLEMAS
           =============================================== */

        canvas {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            z-index: 1;
            pointer-events: none;
            overflow: hidden !important;
        }

        /* ===============================================
           ELEMENTOS DE FONDO SIN OVERFLOW
           =============================================== */

        .cyber-grid,
        .organic-shapes,
        .particles-container,
        .news-background {
            position: fixed !important;
            overflow: hidden !important;
            pointer-events: none !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
        }

        /* ===============================================
           MENÚ Y ESPACIADO
           =============================================== */

        .has-menu .content-wrapper {
            padding-top: 70px;
        }

        .no-menu .content-wrapper {
            padding-top: 0;
        }

        @media (max-width: 768px) {
            .has-menu .content-wrapper {
                padding-top: 60px;
            }
            
            /* MÓVIL: Asegurar que no hay overflow horizontal */
            html, body {
                overflow-x: hidden !important;
                width: 100vw !important;
                max-width: 100vw !important;
            }
        }

        /* ===============================================
           OPTIMIZACIONES SEGURAS SOLO DONDE NECESARIO
           =============================================== */

        /* Solo aplicar optimizaciones a elementos específicos que las necesitan */
        .btn-start:hover,
        .btn-login:hover,
        .nav-link:hover,
        .mobile-nav-link:hover {
            transform: translateZ(0);
            will-change: transform;
        }

        /* ===============================================
           SCROLLBAR PERSONALIZADA ÚNICA
           =============================================== */

        ::-webkit-scrollbar {
            width: 10px;
            background: rgba(10, 25, 47, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 157, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 157, 0.7);
        }

        /* Para Firefox */
        html {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 255, 157, 0.5) rgba(10, 25, 47, 0.3);
        }

        /* ===============================================
           GRID Y FLEXBOX SIN PROBLEMAS
           =============================================== */

        .news-grid,
        .cards-container {
            width: 100% !important;
            max-width: 100% !important;
            overflow: visible !important;
        }

        /* ===============================================
           MOBILE MENU SCROLL CONTROLADO
           =============================================== */

        .mobile-menu-content {
            /* ÚNICA EXCEPCIÓN: Solo el menú móvil puede tener scroll interno */
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 85vh;
            width: 100%;
            max-width: 100%;
        }

        /* ===============================================
           CONTENEDORES ESPECÍFICOS CON MÁRGENES
           =============================================== */

        /* Restaurar márgenes para el contenedor de artículos */
        .article-container {
            max-width: 900px !important;
            margin: 0 auto !important;
            padding: 30px 20px !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        /* CRÍTICO: Centrar el contenido de noticias */
        .news-content {
            max-width: 1200px !important;
            margin: 0 auto !important;
            padding: 0 24px !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Centrar grid de noticias */
        .news-grid {
            max-width: 1200px !important;
            margin: 0 auto !important;
            padding: 0 !important;
        }

        /* Centrar artículo destacado */
        .featured-article {
            max-width: 1200px !important;
            margin: 0 auto 30px auto !important;
            width: 100% !important;
        }

        /* Centrar header de sección */
        .news-section-header {
            max-width: 1200px !important;
            margin: 0 auto !important;
            padding: 30px 24px 60px 24px !important;
        }

        /* Asegurar que otros contenedores de contenido también tengan márgenes apropiados */
        .create-news-container,
        .login-container,
        .recovery-container {
            max-width: 450px !important;
            margin: 0 auto !important;
            padding: 2rem !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .create-news-container {
            max-width: 900px !important;
        }

        /* Centrar contenido del marketplace */
        .main-content {
            max-width: 1200px !important;
            margin: 0 auto !important;
            padding: 20px !important;
        }

        /* Responsive para móviles */
        @media (max-width: 768px) {
            .article-container {
                padding: 20px 15px !important;
                margin: 0 15px !important;
                max-width: calc(100vw - 30px) !important;
            }
            
            .news-content {
                padding: 0 16px !important;
                margin: 0 !important;
                max-width: 100vw !important;
            }
            
            .news-grid,
            .featured-article {
                margin: 0 !important;
                max-width: 100% !important;
            }
            
            .news-section-header {
                padding: 20px 16px 40px 16px !important;
                margin: 0 !important;
            }
            
            .create-news-container,
            .login-container,
            .recovery-container {
                padding: 1.5rem 15px !important;
                margin: 0 15px !important;
                max-width: calc(100vw - 30px) !important;
            }
            
            .main-content {
                padding: 15px !important;
                margin: 0 !important;
            }
        }

        /* ===============================================
           DEBUG: Detectar elementos que causan overflow
           =============================================== */

        /* Uncomment para debug: */
        /*
        * {
            outline: 1px solid rgba(255, 0, 0, 0.1) !important;
        }
        
        *:hover {
            outline: 2px solid rgba(255, 255, 0, 0.3) !important;
        }
        */
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body class="{% if request.resolver_match.url_name == 'index' %}no-menu{% else %}has-menu{% endif %}">
    <!-- Incluir el menú de navegación solo para páginas que no sean las seleccionadas-->
    {% if request.resolver_match.url_name not in 'index,login,password_recovery,register,marketplace' %}
    {% include 'core/includes/menu_nav.html' %}
    {% endif %}

    <canvas id="backgroundCanvas"></canvas>
    <div class="content-wrapper">
        {% block content %}{% endblock %}
    </div>

    <!-- Scripts base SIN optimizaciones problemáticas -->
    <script>
        // Clase de canvas simple SIN optimizaciones que causen problemas
        class CanvasEffect {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            clear() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }
        }

        // Función para verificar usuario logueado
        function isUserLoggedIn() {
            return !!(
                document.querySelector('.user-info') || 
                document.querySelector('.mobile-nav-link.logout') ||
                document.body.classList.contains('has-menu') ||
                '{{ request.session.user_id }}'
            );
        }

        // Variables globales
        window.userSessionData = {
            isLoggedIn: isUserLoggedIn(),
            userId: '{{ request.session.user_id|default:"" }}',
            username: '{{ request.session.username|default:"" }}',
            startTime: Date.now()
        };

        // DEBUG: Detectar elementos que causan overflow horizontal
        function detectHorizontalOverflow() {
            const elements = document.querySelectorAll('*');
            const body = document.body;
            const html = document.documentElement;
            
            const bodyWidth = body.clientWidth;
            
            elements.forEach(element => {
                if (element.scrollWidth > bodyWidth) {
                    console.warn('Elemento causa overflow horizontal:', element, 'Width:', element.scrollWidth);
                }
            });
        }

        // Ejecutar debug después de cargar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔐 Estado de sesión:', window.userSessionData);
            
            // Uncomment para detectar problemas de overflow:
            // setTimeout(detectHorizontalOverflow, 1000);
        });

        // SCROLL LOCK: Prevenir scroll horizontal en cualquier elemento
        document.addEventListener('DOMContentLoaded', function() {
            // Forzar que ningún elemento cause scroll horizontal
            const style = document.createElement('style');
            style.textContent = `
                * {
                    max-width: 100vw !important;
                }
                
                body, html {
                    overflow-x: hidden !important;
                }
            `;
            document.head.appendChild(style);
        });
    </script>

    <!-- Sistema de auto-logout simple -->
    {% if request.session.user_id %}
    <script src="{% static 'core/js/auto-logout.js' %}?v=1"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🕐 Iniciando auto-logout para {{ request.session.username }}');
            
            if ('{{ request.session.user_id }}') {
                if (typeof AutoLogoutSystem !== 'undefined') {
                    window.autoLogoutSystem = new AutoLogoutSystem({
                        timeout: 3 * 60 * 1000,
                        warningTime: 30 * 1000,
                        logoutUrl: '{% url "core:login" %}',
                        checkInterval: 1000
                    });
                    
                    console.log('✅ Auto-logout configurado');
                }
            }
        });
    </script>
    {% endif %}

    {% block extra_js %}{% endblock %}
</body>

</html>